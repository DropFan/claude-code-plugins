---
allowed-tools: Bash(pwd:*), Bash(date:*), Read, Glob, AskUserQuestion, mcp__*notion*, mcp__*feishu*, mcp__*lark*
description: Export a conversation to Notion or Feishu
argument-hint: "<platform: notion|feishu> [scope: full|summary]"
---

## Context

- Working directory: !`pwd`
- Current date: !`date '+%Y-%m-%d %H:%M'`

## Task

Export the current conversation to an external platform (Notion or Feishu/飞书) via MCP integration.

**User arguments:** $ARGUMENTS

### Step 0: Load Settings

1. Use the Read tool to check if `.claude/chat-saver.local.md` exists
2. If it exists, parse the YAML frontmatter between `---` markers to extract:
   - `default_scope` — fallback scope if not specified in arguments
   - `save_dir` — used as fallback save location if MCP export fails
   - `custom_footer` — custom footer text (replaces default plugin attribution)
3. If the file does not exist, use defaults silently

### Step 1: Parse Arguments

Parse arguments from $ARGUMENTS:

- **platform** (required) — `notion` or `feishu`
- **scope** — `full` (default) or `summary`

If no platform is specified, use AskUserQuestion to let the user choose:
- **Notion** — Export to a Notion page
- **Feishu (飞书)** — Export to a Feishu document

### Step 2: Check MCP Availability

This plugin does **not** ship its own MCP servers. It relies on MCP servers already configured in the user's environment (project `.mcp.json`, or global `~/.claude/.mcp.json`).

Detect available MCP tools by checking for tools matching these patterns:

- **Notion**: tools matching `mcp__*notion*` (e.g., `mcp__notion-mcp__*`, `mcp__notion__*`)
- **Feishu**: tools matching `mcp__*feishu*` or `mcp__*lark*` (e.g., `mcp__feishu-mcp__*`, `mcp__lark__*`)

If no matching MCP tools are found for the selected platform:
1. Inform the user that no MCP server for the platform was detected
2. Provide setup instructions:
   - For Notion: add `@notionhq/notion-mcp-server` to project or global `.mcp.json` with `NOTION_TOKEN`
   - For Feishu: add a Feishu MCP server (SSE or stdio) to `.mcp.json`
3. Refer them to `references/mcp-export-guide.md` in this plugin for detailed setup steps
4. Offer to save locally instead (fall back to save-chat)

### Step 3: Determine Topic

Same as save-chat: Analyze the conversation to extract the main topic (2-4 keywords in kebab-case).

### Step 4: Generate Content

Generate the conversation content in Markdown format (the universal intermediate format for MCP export):

- **Full scope**: Complete conversation in Markdown
- **Summary scope**: Structured summary in Markdown

Include metadata header:
- Title: `Conversation: <topic>`
- Date, project name, working directory

**Footer is MANDATORY** — the exported content must end with a footer:
- If `custom_footer` is set in settings, use it
- Otherwise, use the default: `> Generated by [chat-saver](https://github.com/DropFan/claude-code-plugins/tree/master/plugins/chat-saver) plugin for Claude Code`

### Step 5: Export via MCP

Use the detected MCP tools from Step 2 to export.

**For Notion:**
1. Use Notion MCP tools to create a new page
2. Set the page title to `Conversation: <topic> — <date>`
3. Add the Markdown content as page content
4. Return the Notion page URL

**For Feishu:**
1. Use Feishu MCP tools to create a new document
2. Set the document title to `Conversation: <topic> — <date>`
3. Add the Markdown content as document body
4. Return the Feishu document URL

### Step 6: Report

Report the result to the user:

```
Conversation exported!

  Platform: Notion
  Title: Conversation: auth-implementation — 2024-01-15
  URL: https://notion.so/...
  Scope: Full
```

If export fails, provide the error message and offer to save locally instead.
