#!/bin/bash
# raw-export.sh — Export raw conversation data from Claude Code JSONL session files
# Reads JSONL directly via jq, ensuring complete and faithful data export.

set -euo pipefail

# ── Defaults ──────────────────────────────────────────────────────────

FORMAT="md"
FULL_MODE=false
LIST_MODE=false
OUTPUT_FILE=""
PROJECT_DIR=""
FOOTER_TEXT='Generated by [chat-saver](https://github.com/DropFan/claude-code-plugins/tree/master/plugins/chat-saver) plugin for Claude Code'
NO_FOOTER=false
JSONL_FILE=""

# ── Usage ─────────────────────────────────────────────────────────────

usage() {
  cat <<'USAGE'
Usage: raw-export.sh [OPTIONS] <jsonl-file>

Options:
  --format <jsonl|json|md|html>  Output format (default: md)
  --full                         Include all record types (progress, etc.)
  --list                         List available sessions in project dir
  --project-dir <path>           Project data directory
  --output <file>                Output file path
  --footer <text>                Custom footer text
  --no-footer                    Omit footer (useful for jsonl/json)
  -h, --help                     Show this help
USAGE
  exit 0
}

# ── Argument parsing ──────────────────────────────────────────────────

while [[ $# -gt 0 ]]; do
  case "$1" in
    --format)     FORMAT="$2"; shift 2 ;;
    --full)       FULL_MODE=true; shift ;;
    --list)       LIST_MODE=true; shift ;;
    --project-dir) PROJECT_DIR="$2"; shift 2 ;;
    --output)     OUTPUT_FILE="$2"; shift 2 ;;
    --footer)     FOOTER_TEXT="$2"; shift 2 ;;
    --no-footer)  NO_FOOTER=true; shift ;;
    -h|--help)    usage ;;
    -*)           echo "Unknown option: $1" >&2; exit 1 ;;
    *)            JSONL_FILE="$1"; shift ;;
  esac
done

# ── Dependency check ──────────────────────────────────────────────────

if ! command -v jq &>/dev/null; then
  echo '{"error":"jq is required but not found. Install with: brew install jq"}' >&2
  exit 1
fi

# ── List mode ─────────────────────────────────────────────────────────

if $LIST_MODE; then
  if [[ -z "$PROJECT_DIR" ]]; then
    echo '{"error":"--project-dir is required for --list mode"}' >&2
    exit 1
  fi
  if [[ ! -d "$PROJECT_DIR" ]]; then
    echo "{\"error\":\"Project directory not found: $PROJECT_DIR\"}" >&2
    exit 1
  fi

  # Collect session info from JSONL files (newest first, max 20)
  echo "| # | Session ID | First Message | Date | Records |"
  echo "|---|-----------|---------------|------|---------|"

  IDX=0
  for f in $(ls -t "$PROJECT_DIR"/*.jsonl 2>/dev/null | head -20); do
    IDX=$((IDX + 1))
    BASENAME=$(basename "$f" .jsonl)
    TOTAL=$(wc -l < "$f" | tr -d ' ')
    TIMESTAMP=$(jq -r 'select(.type == "user") | .timestamp // empty' "$f" 2>/dev/null | head -1 || true)
    DATE_STR="${TIMESTAMP:0:16}"
    # Get first user text message (truncated)
    FIRST_MSG=$(jq -r '
      select(.type == "user") |
      if (.message.content | type) == "string" then .message.content
      elif (.message.content | type) == "array" then
        [.message.content[] | select(.type == "text") | .text] | first // "[tool result]"
      else empty end
    ' "$f" 2>/dev/null | head -1 | cut -c1-60 || true)
    # Escape pipes for table
    FIRST_MSG=$(echo "$FIRST_MSG" | tr '|' '/')
    if [[ ${#FIRST_MSG} -ge 60 ]]; then
      FIRST_MSG="${FIRST_MSG}..."
    fi
    echo "| $IDX | ${BASENAME:0:8}... | ${FIRST_MSG:-[empty]} | ${DATE_STR:0:10} | $TOTAL |"
  done

  if [[ $IDX -eq 0 ]]; then
    echo "(no sessions found)"
  fi
  exit 0
fi

# ── Export mode — validate inputs ─────────────────────────────────────

if [[ -z "$JSONL_FILE" ]]; then
  echo '{"error":"No JSONL file specified"}' >&2
  exit 1
fi

if [[ ! -f "$JSONL_FILE" ]]; then
  echo "{\"error\":\"JSONL file not found: $JSONL_FILE\"}" >&2
  exit 1
fi

if [[ -z "$OUTPUT_FILE" ]]; then
  echo '{"error":"--output is required for export mode"}' >&2
  exit 1
fi

# ── jq filter: extract text from messages ─────────────────────────────

# Build the jq filter based on mode
if $FULL_MODE; then
  TYPE_FILTER='true'
else
  TYPE_FILTER='(.type == "user" or .type == "assistant")'
fi

# ── Format: jsonl ─────────────────────────────────────────────────────

export_jsonl() {
  jq -c "select($TYPE_FILTER)" "$JSONL_FILE" > "$OUTPUT_FILE"

  TOTAL=$(wc -l < "$JSONL_FILE" | tr -d ' ')
  EXPORTED=$(wc -l < "$OUTPUT_FILE" | tr -d ' ')
  USER_COUNT=$(jq -c 'select(.type == "user")' "$OUTPUT_FILE" 2>/dev/null | wc -l | tr -d ' ')
  ASST_COUNT=$(jq -c 'select(.type == "assistant")' "$OUTPUT_FILE" 2>/dev/null | wc -l | tr -d ' ')
  FILE_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1 | tr -d ' ')

  echo "{\"file\":\"$OUTPUT_FILE\",\"format\":\"jsonl\",\"total_records\":$TOTAL,\"exported_records\":$EXPORTED,\"user_records\":$USER_COUNT,\"assistant_records\":$ASST_COUNT,\"size\":\"$FILE_SIZE\"}"
}

# ── Format: json ──────────────────────────────────────────────────────

export_json() {
  jq -c "select($TYPE_FILTER)" "$JSONL_FILE" | jq -s '.' > "$OUTPUT_FILE"

  TOTAL=$(wc -l < "$JSONL_FILE" | tr -d ' ')
  EXPORTED=$(jq 'length' "$OUTPUT_FILE")
  USER_COUNT=$(jq '[.[] | select(.type == "user")] | length' "$OUTPUT_FILE")
  ASST_COUNT=$(jq '[.[] | select(.type == "assistant")] | length' "$OUTPUT_FILE")
  FILE_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1 | tr -d ' ')

  echo "{\"file\":\"$OUTPUT_FILE\",\"format\":\"json\",\"total_records\":$TOTAL,\"exported_records\":$EXPORTED,\"user_records\":$USER_COUNT,\"assistant_records\":$ASST_COUNT,\"size\":\"$FILE_SIZE\"}"
}

# ── Format: md ────────────────────────────────────────────────────────

export_md() {
  SESSION_ID=$(basename "$JSONL_FILE" .jsonl)
  FIRST_TS=$(jq -r 'select(.timestamp) | .timestamp' "$JSONL_FILE" 2>/dev/null | head -1)
  DATE_STR="${FIRST_TS:0:16}"

  # Write jq filter to temp file to avoid bash escaping issues
  local JQ_FILTER
  JQ_FILTER=$(mktemp)
  trap "rm -f '$JQ_FILTER'" RETURN

  cat > "$JQ_FILTER" <<'JQFILTER'
select(TYPEFILTER) |
if .type == "user" then
  "---\n\n## User\n\n" + (
    if (.message.content | type) == "string" then
      .message.content
    elif (.message.content | type) == "array" then
      [.message.content[] |
        if .type == "text" then .text
        elif .type == "tool_result" then
          "> **[Tool Output]** " + (
            if (.content | type) == "string" then
              (.content | split("\n") | first | .[0:200])
            elif (.content | type) == "array" then
              ([.content[] | select(.type == "text") | .text] | first // "[result]") | split("\n") | first | .[0:200]
            else "[result]"
            end
          )
        else empty
        end
      ] | join("\n\n")
    else "[unknown content]"
    end
  ) + "\n"
elif .type == "assistant" then
  "---\n\n## Assistant\n\n" + (
    [.message.content[] |
      if .type == "text" then .text
      elif .type == "tool_use" then
        "> **[" + .name + "]** " + (
          if .name == "Read" then (.input.file_path // "")
          elif .name == "Write" then (.input.file_path // "")
          elif .name == "Edit" then (.input.file_path // "")
          elif .name == "Bash" then (.input.command // "" | split("\n") | first | .[0:100])
          elif .name == "Glob" then (.input.pattern // "")
          elif .name == "Grep" then (.input.pattern // "")
          elif .name == "Task" then (.input.description // "")
          elif .name == "Skill" then (.input.skill // "")
          else (.input | tostring | .[0:100])
          end
        )
      elif .type == "thinking" then empty
      else empty
      end
    ] | join("\n\n")
  ) + "\n"
elif .type == "progress" then
  "> _[progress: " + (.timestamp // "?") + "]_\n"
else
  "> _[" + .type + "]_\n"
end
JQFILTER

  # Replace TYPEFILTER placeholder with actual filter
  if $FULL_MODE; then
    sed -i '' 's/TYPEFILTER/true/' "$JQ_FILTER"
  else
    sed -i '' 's/TYPEFILTER/.type == "user" or .type == "assistant"/' "$JQ_FILTER"
  fi

  {
    # YAML frontmatter
    echo "---"
    echo "title: \"Raw Export: ${SESSION_ID:0:8}\""
    echo "date: ${DATE_STR:-unknown}"
    echo "session: $SESSION_ID"
    echo "generator: chat-saver/raw-export"
    echo "---"
    echo ""
    echo "# Raw Export: ${SESSION_ID:0:8}"
    echo ""

    # Process each record using jq filter file
    jq -r -f "$JQ_FILTER" "$JSONL_FILE"

    echo ""
    echo "---"
    echo ""

    # Footer
    if ! $NO_FOOTER; then
      echo "> $FOOTER_TEXT"
    fi
  } > "$OUTPUT_FILE"

  # Collect stats
  TOTAL=$(wc -l < "$JSONL_FILE" | tr -d ' ')
  USER_COUNT=$(jq -c 'select(.type == "user")' "$JSONL_FILE" | wc -l | tr -d ' ')
  ASST_COUNT=$(jq -c 'select(.type == "assistant")' "$JSONL_FILE" | wc -l | tr -d ' ')
  FILE_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1 | tr -d ' ')

  echo "{\"file\":\"$OUTPUT_FILE\",\"format\":\"md\",\"session\":\"$SESSION_ID\",\"total_records\":$TOTAL,\"user_records\":$USER_COUNT,\"assistant_records\":$ASST_COUNT,\"size\":\"$FILE_SIZE\"}"
}

# ── Format: html ──────────────────────────────────────────────────────

export_html() {
  SESSION_ID=$(basename "$JSONL_FILE" .jsonl)
  FIRST_TS=$(jq -r 'select(.timestamp) | .timestamp' "$JSONL_FILE" 2>/dev/null | head -1)
  DATE_STR="${FIRST_TS:0:16}"

  # Write jq filter to temp file to avoid bash escaping issues
  local JQ_FILTER
  JQ_FILTER=$(mktemp)
  trap "rm -f '$JQ_FILTER'" RETURN

  cat > "$JQ_FILTER" <<'JQFILTER'
select(TYPEFILTER) |

def html_escape: gsub("&"; "&amp;") | gsub("<"; "&lt;") | gsub(">"; "&gt;");

if .type == "user" then
  "<div class=\"exchange\"><div class=\"user\"><div class=\"role\">User</div><div class=\"content\">" + (
    if (.message.content | type) == "string" then
      (.message.content | html_escape)
    elif (.message.content | type) == "array" then
      [.message.content[] |
        if .type == "text" then (.text | html_escape)
        elif .type == "tool_result" then
          "<div class=\"tool-output\">" + (
            if (.content | type) == "string" then (.content | html_escape | .[0:500])
            elif (.content | type) == "array" then
              ([.content[] | select(.type == "text") | (.text | html_escape)] | first // "[result]") | .[0:500]
            else "[result]"
            end
          ) + "</div>"
        else empty
        end
      ] | join("")
    else "[unknown]"
    end
  ) + "</div></div>"
elif .type == "assistant" then
  "<div class=\"assistant\"><div class=\"role\">Assistant</div><div class=\"content\">" + (
    [.message.content[] |
      if .type == "text" then (.text | html_escape)
      elif .type == "tool_use" then
        "<div class=\"tool-call\">[" + .name + "] " + (
          if .name == "Read" then (.input.file_path // "" | html_escape)
          elif .name == "Write" then (.input.file_path // "" | html_escape)
          elif .name == "Edit" then (.input.file_path // "" | html_escape)
          elif .name == "Bash" then (.input.command // "" | split("\n") | first | .[0:100] | html_escape)
          elif .name == "Glob" then (.input.pattern // "" | html_escape)
          elif .name == "Grep" then (.input.pattern // "" | html_escape)
          else (.input | tostring | .[0:100] | html_escape)
          end
        ) + "</div>"
      elif .type == "thinking" then empty
      else empty
      end
    ] | join("")
  ) + "</div></div></div>"
elif .type == "progress" then
  "<!-- progress: " + (.timestamp // "?") + " -->"
else empty
end
JQFILTER

  # Replace TYPEFILTER placeholder with actual filter
  if $FULL_MODE; then
    sed -i '' 's/TYPEFILTER/true/' "$JQ_FILTER"
  else
    sed -i '' 's/TYPEFILTER/.type == "user" or .type == "assistant"/' "$JQ_FILTER"
  fi

  {
    cat <<HTMLHEAD
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="chat-saver/raw-export">
  <title>Raw Export: ${SESSION_ID:0:8}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
      line-height: 1.6;
      color: #333;
    }
    h1 {
      font-size: 1.5rem;
      border-bottom: 2px solid #333;
      padding-bottom: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .meta {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 1.5rem;
    }
    .exchange {
      margin: 1.5rem 0;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 1.5rem;
    }
    .user {
      background: #f0f4ff;
      padding: 1rem;
      border-radius: 8px;
      margin: 0.5rem 0;
    }
    .assistant {
      background: #f8f8f8;
      padding: 1rem;
      border-radius: 8px;
      margin: 0.5rem 0;
    }
    .role {
      font-weight: 600;
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }
    .user .role { color: #2563eb; }
    .assistant .role { color: #059669; }
    .tool-call {
      background: #f5f0ff;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 0.9em;
      color: #6b21a8;
      margin: 0.25rem 0;
    }
    .tool-output {
      background: #fefce8;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85em;
      color: #854d0e;
      margin: 0.25rem 0;
      max-height: 200px;
      overflow-y: auto;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
      margin: 0.5rem 0;
    }
    code {
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      font-size: 0.9em;
    }
    p code {
      background: #f0f0f0;
      padding: 0.15em 0.3em;
      border-radius: 3px;
    }
    .content { white-space: pre-wrap; word-wrap: break-word; }
    .footer {
      text-align: center;
      color: #999;
      font-size: 0.8em;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #e0e0e0;
    }
    .footer a { color: #999; text-decoration: none; }
    .footer a:hover { color: #666; text-decoration: underline; }
  </style>
</head>
<body>
  <h1>Raw Export: ${SESSION_ID:0:8}</h1>
  <p class="meta">Date: ${DATE_STR:-unknown} | Session: ${SESSION_ID}</p>
HTMLHEAD

    # Process messages into HTML using jq filter file
    jq -r -f "$JQ_FILTER" "$JSONL_FILE"

    # Footer
    if ! $NO_FOOTER; then
      echo '  <div class="footer">Generated by <a href="https://github.com/DropFan/claude-code-plugins/tree/master/plugins/chat-saver">chat-saver</a> plugin for <a href="https://claude.ai/download">Claude Code</a></div>'
    fi

    echo '</body>'
    echo '</html>'
  } > "$OUTPUT_FILE"

  # Collect stats
  TOTAL=$(wc -l < "$JSONL_FILE" | tr -d ' ')
  USER_COUNT=$(jq -c 'select(.type == "user")' "$JSONL_FILE" | wc -l | tr -d ' ')
  ASST_COUNT=$(jq -c 'select(.type == "assistant")' "$JSONL_FILE" | wc -l | tr -d ' ')
  FILE_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1 | tr -d ' ')

  echo "{\"file\":\"$OUTPUT_FILE\",\"format\":\"html\",\"session\":\"$SESSION_ID\",\"total_records\":$TOTAL,\"user_records\":$USER_COUNT,\"assistant_records\":$ASST_COUNT,\"size\":\"$FILE_SIZE\"}"
}

# ── Dispatch ──────────────────────────────────────────────────────────

case "$FORMAT" in
  jsonl) export_jsonl ;;
  json)  export_json ;;
  md)    export_md ;;
  html)  export_html ;;
  *)     echo "{\"error\":\"Unknown format: $FORMAT. Supported: jsonl, json, md, html\"}" >&2; exit 1 ;;
esac
